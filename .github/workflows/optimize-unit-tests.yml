name: Optimize Unit Tests
on:
  workflow_call:

jobs:
  detect-changes:
    name: Get changed directories
    runs-on: ubuntu-latest
    outputs:
      backend-changes: ${{ steps.filter.outputs.optimize-backend-changes }}
      frontend-changes: ${{ steps.filter.outputs.optimize-frontend-changes }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4

    - name: Get list of changed directories
      id: filter
      uses: ./.github/actions/paths-filter
  unit-tests-backend:
    name: Optimize Unit Tests - Backend
    runs-on: gcp-core-8-default
    timeout-minutes: 30
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.backend-changes == 'true' }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4

    - name: Fetch main branch
      run: git fetch origin main:refs/remote/origin/main

    - name: Setup Maven
      uses: ./.github/actions/setup-maven
      with:
        secrets: ${{ toJSON(secrets) }}

    - name: Test
      uses: ./.github/actions/run-maven
      with:
        parameters: -f optimize/pom.xml test -Dskip.fe.build -Dskip.docker

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4
      with:
        name: unit-tests-backend-junit
        path: |
          **/surefire-reports/**/*.xml
        retention-days: 7
        if-no-files-found: ignore

    - name: Observe build status
      if: always()
      continue-on-error: true
      uses: ./.github/actions/observe-build-status
      with:
        build_status: ${{ job.status }}
        secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
        secret_vault_address: ${{ secrets.VAULT_ADDR }}
        secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}

  unit-tests-frontend:
    name: Optimize Unit Tests - Frontend
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.frontend-changes == 'true' }}
    defaults:
      run:
        working-directory: optimize/client
    steps:
    - name: Checkout repository
      uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4

    - name: Fetch main branch
      run: git fetch origin main:refs/remote/origin/main

    - name: "Parse pom.xml for versions"
      id: "pom_info"
      uses: YunaBraska/java-info-action@main

    - name: Set Node.js
      uses: actions/setup-node@1e60f620b9541d16bece96c5465dc8ee9832be0b # v4
      with:
        node-version: ${{ steps.pom_info.outputs.x_version_node }}
        cache: yarn
        cache-dependency-path: yarn.lock

    - name: Pull Dependencies
      run: |
        yarn

    - name: Test
      run: |
        yarn test:ci

    - name: Upload Test Results
      if: always()
      uses: actions/upload-artifact@834a144ee995460fba8ed112a2fc961b36a5ec5a # v4
      with:
        name: unit-tests-frontend-junit
        path: |
          **/jest-test-results.xml
        retention-days: 7
        if-no-files-found: ignore

    - name: Observe build status
      if: always()
      continue-on-error: true
      uses: ./.github/actions/observe-build-status
      with:
        build_status: ${{ job.status }}
        secret_vault_secretId: ${{ secrets.VAULT_SECRET_ID }}
        secret_vault_address: ${{ secrets.VAULT_ADDR }}
        secret_vault_roleId: ${{ secrets.VAULT_ROLE_ID }}
